name: Release

on:
  workflow_dispatch:
    inputs:
      description:
        description: 'Release description to append to the title (e.g. "Bug fixes")'
        required: true
        type: string

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.getver.outputs.version }}
      tag: ${{ steps.getver.outputs.tag }}
      title: ${{ steps.getver.outputs.title }}
      body: ${{ steps.changelog.outputs.body }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Get version from csproj (trim to 3 parts)
        id: getver
        env:
          DESC: ${{ inputs.description }}
        run: |
          VER=$(grep -oPm1 "(?<=<Version>)[^<]+" MarkdownGitDiffMarker.csproj)
          if [ -z "$VER" ]; then echo "Version not found in csproj"; exit 1; fi
          RELVER=$(echo "$VER" | cut -d. -f1-3)
          echo "version=$RELVER" >> $GITHUB_OUTPUT
          echo "tag=v$RELVER" >> $GITHUB_OUTPUT
          echo "title=v$RELVER - $DESC" >> $GITHUB_OUTPUT

      - name: Generate changelog since last tag
        id: changelog
        run: |
          git fetch --tags --force || true
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..HEAD"
          else
            RANGE=""
          fi
          echo "Previous tag: $PREV_TAG"
          if [ -n "$RANGE" ]; then
            BODY=$(git log --pretty=format:'- %s (%h)' $RANGE)
          else
            BODY=$(git log --pretty=format:'- %s (%h)')
          fi
          if [ -z "$BODY" ]; then
            BODY="No changes"
          fi
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  build:
    needs: version
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            label: Win-x64
            ext: ".exe"
          - os: windows-latest
            rid: win-arm64
            label: Win-arm64
            ext: ".exe"
          - os: ubuntu-latest
            rid: linux-x64
            label: Linux-x64
            ext: ""
          - os: ubuntu-latest
            rid: linux-arm64
            label: Linux-arm64
            ext: ""
          - os: macos-latest
            rid: osx-x64
            label: MacOS-x64
            ext: ""
          - os: macos-latest
            rid: osx-arm64
            label: MacOS-arm64
            ext: ""
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        run: dotnet restore MarkdownGitDiffMarker.csproj

      - name: Publish ${{ matrix.rid }}
        run: dotnet publish MarkdownGitDiffMarker.csproj -c Release -r ${{ matrix.rid }} -p:PublishSingleFile=true -p:SelfContained=true -p:PublishTrimmed=true -p:EnableCompressionInSingleFile=true

      - name: Package artifact
        id: package
        shell: pwsh
        run: |
          $version='${{ needs.version.outputs.version }}'
          $label='${{ matrix.label }}'
          $name='MarkdownGitDiffMarker'
          $rid='${{ matrix.rid }}'
          $ext='${{ matrix.ext }}'
          $binPath="bin/Release/net9.0/$rid/publish/$name$ext"
          if (!(Test-Path $binPath)) { Get-ChildItem -Recurse bin/Release | Write-Host; throw "Binary not found at $binPath" }
          $zipName="$name-v$version-$label$ext.zip"
          if (Test-Path $zipName) { Remove-Item $zipName }
          if ($IsWindows) {
            Compress-Archive -Path $binPath -DestinationPath $zipName
          } else {
            & zip -j $zipName $binPath
          }
          echo "artifact_name=$zipName" >> $env:GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.artifact_name }}
          path: ${{ steps.package.outputs.artifact_name }}

  release:
    needs: [version, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts (flatten)
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: List files to upload
        run: |
          ls -la dist

      - name: Create or update GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.version.outputs.tag }}
          name: ${{ needs.version.outputs.title }}
          body: ${{ needs.version.outputs.body }}
          artifacts: dist/*
          allowUpdates: true
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
